<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UKM Catur</title>
    <link rel="icon" type="image/x-icon" href="/ico/ukm chess pcu.ico" />

    <style>
      #root {
        transition: opacity 0.6s ease 0.3s;
        /* opacity: 0; */
      }

      #preloader {
        position: fixed;
        inset: 0;
        background: linear-gradient(to bottom, #0a0007, #0f1028);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.8s cubic-bezier(0.77, 0, 0.175, 1),
                    opacity 0.5s ease-in-out;
        transform: translateY(0);
      }

      #preloader.loaded {
        transform: translateY(-100%);
        pointer-events: none;
      }


      #root.loaded {
        opacity: 1;
      }

      .preloader-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
        width: 200px;
        text-align: center;
      }

      .preloader-logo {
        width: 60px;
        height: 60px;
        background-image: url('/svg/icons/knight icon w.svg');
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
      }

      .preloader-bar-container {
        width: 100%;
        height: 4px;
        background-color: #333;
        border-radius: 2px;
        overflow: hidden;
      }

      #preloader-bar {
        width: 0%;
        height: 100%;
        background-color: #FFD700;
        transition: width 0.3s ease-out;
      }

      #preloader-percentage {
        color: #FFD700;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        font-size: 1rem;
        font-weight: 500;
      }
    </style>
  </head>
  <body>
    <div id="preloader">
      <div class="preloader-content">
        <div class="preloader-logo"></div>
        <div class="preloader-bar-container">
          <div id="preloader-bar"></div>
        </div>
        <div id="preloader-percentage">0%</div>
      </div>
    </div>

    <div id="root"></div>

    <script>
      (function () {
        const preloader = document.getElementById("preloader");
        const root = document.getElementById("root");
        const progressBar = document.getElementById("preloader-bar");
        const percentageText = document.getElementById("preloader-percentage");

        // asset manifest defs

        // 1. assets for the Homepage (which includes PesertaFeatures)
        const HOME_ASSETS_SET = new Set([
          // WEBM (HomePage)
          "/webm/hero-video.webm",
          // PesertaFeatures SVGs
          "/svg/blocks/book.svg",
          "/svg/blocks/sight.svg",
          "/svg/blocks/trophy.svg",
          "/svg/blocks/sandglass.svg",
          "/svg/blocks/block b m.svg",
          "/svg/blocks/block w m.svg",
          // Vision SVGs
          "/svg/icons/pawn icon w.svg",
          "/svg/icons/queen icon w.svg",
          "/svg/icons/rook icon w.svg",
          "/svg/icons/knight icon w.svg",
          "/svg/icons/king icon w.svg",
          "/svg/icons/bishop icon w.svg",
          "/svg/eyeball b.svg",
          "/svg/pupil.svg",
          "/svg/pieces/pawn white.svg",
          // Mission SVGs
          "/svg/pieces/knight white.svg",
          "/svg/pieces/bishop white.svg",
          "/svg/pieces/queen black d.svg",
          "/svg/pieces/pawn black b.svg",
          "/svg/pieces/rook white.svg",
          "/svg/pieces/bishop black b.svg",
          "/svg/hand round.svg",
          // AnimatedChessboard SVGs
          "/svg/icons/pawn icon.svg",
          "/svg/icons/rook icon.svg",
          "/svg/icons/knight icon.svg",
          "/svg/icons/bishop icon.svg",
          "/svg/icons/queen icon.svg",
          "/svg/icons/king icon.svg",
          "/svg/icons/white tile.svg",
          "/svg/icons/black tile.svg",
          // Gallery WEBPs
          "/webp/last-period/1.webp",
          "/webp/last-period/2.webp",
          "/webp/last-period/3.webp",
          "/webp/last-period/4.webp",
          "/webp/last-period/5.webp",
          "/webp/openhouse/1.webp",
          "/webp/openhouse/2.webp",
          "/webp/openhouse/3.webp",
          "/webp/openhouse/4.webp",
          "/webp/openhouse/5.webp",
          "/webp/week-1/1.webp",
          "/webp/week-1/2.webp",
          "/webp/week-1/3.webp",
          "/webp/week-1/4.webp",
          "/webp/week-1/5.webp",
          "/webp/bella-mascot.webp",
        ]);
        const HOME_ASSETS = Array.from(HOME_ASSETS_SET);

        // 2. assets for the Peserta Login Page
        const LOGIN_ASSETS_SET = new Set([
          "/svg/blocks/block w m.svg",
          "/svg/blocks/block w main.svg",
          "/svg/blocks/block b m.svg",
          "/svg/blocks/block-b-main.svg",
          "/svg/chess logo.svg"
        ]);
        const LOGIN_ASSETS = Array.from(LOGIN_ASSETS_SET);
        
        // to get the correct asset list based on the url path
        function getManifestForPath(path) {
          if (path.startsWith("/peserta/login")) {
            return LOGIN_ASSETS;
          }
          if (path.startsWith("/admin/login")) {
            return [];
          }
          return HOME_ASSETS;
        }

        // logic    
        const currentPath = window.location.pathname;
        const ASSET_MANIFEST = getManifestForPath(currentPath);

        const totalAssets = ASSET_MANIFEST.length;
        let loadedAssets = 0;

        // to update progress
        function updateProgress() {
          loadedAssets++;
          const percentage = Math.round((loadedAssets / totalAssets) * 100);

          if (progressBar) {
            progressBar.style.width = percentage + "%";
          }
          if (percentageText) {
            percentageText.textContent = percentage + "%";
          }

          if (loadedAssets === totalAssets) {
            setTimeout(finishLoading, 300);
          }
        }

        // to finish loading and reveal page
        function finishLoading() {
          if (preloader) {
            preloader.classList.add("loaded");
          }
          if (root) {
            root.classList.add("loaded");
          }
        }

        // to load single asset
        function loadAsset(url) {
          return new Promise((resolve, reject) => {
            const extension = url.split(".").pop();

            if (["webp", "svg", "png", "jpg"].includes(extension)) {
              const img = new Image();
              img.src = url;
              img.onload = resolve;
              img.onerror = reject;
            } else if (["webm", "mp4"].includes(extension)) {
              fetch(url, { cache: "force-cache" })
                .then((response) => {
                  if (response.ok) {
                    resolve();
                  } else {
                    reject(new Error(`Failed to fetch ${url}`));
                  }
                })
                .catch(reject);
            } else {
              console.warn(
                `Preloader: Unknown asset type for ${url}. Assuming loaded.`
              );
              resolve();
            }
          });
        }

        // start loading all assets
        if (totalAssets > 0) {
          ASSET_MANIFEST.forEach((url) => {
            loadAsset(url)
              .then(updateProgress)
              .catch((err) => {
                console.warn(`Preloader: Failed to load asset ${url}.`, err);
                // still call updateProgress to not block the loader
                updateProgress();
              });
          });
        } else {
          if (progressBar) progressBar.style.width = "100%";
          if (percentageText) percentageText.textContent = "100%";
          setTimeout(finishLoading, 100);
        }
      })();
    </script>

    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>